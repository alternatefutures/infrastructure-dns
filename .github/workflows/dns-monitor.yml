name: DNS Health Monitor

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    name: Check DNS Health
    runs-on: ubuntu-latest

    steps:
      - name: Check Cloudflare DNS
        id: cloudflare
        continue-on-error: true
        run: |
          # Query Cloudflare nameserver directly
          RESULT=$(dig @jeremy.ns.cloudflare.com alternatefutures.ai A +short +time=5 +tries=2 2>/dev/null || echo "TIMEOUT")
          if [ -z "$RESULT" ] || [ "$RESULT" = "TIMEOUT" ]; then
            echo "status=down" >> $GITHUB_OUTPUT
            echo "::warning::Cloudflare DNS is DOWN or not responding"
          else
            echo "status=up" >> $GITHUB_OUTPUT
            echo "Cloudflare OK: $RESULT"
          fi

      - name: Check deSEC DNS
        id: desec
        continue-on-error: true
        run: |
          RESULT=$(dig @ns1.desec.io alternatefutures.ai A +short +time=5 +tries=2 2>/dev/null || echo "TIMEOUT")
          if [ -z "$RESULT" ] || [ "$RESULT" = "TIMEOUT" ]; then
            echo "status=down" >> $GITHUB_OUTPUT
            echo "::warning::deSEC DNS is DOWN or not responding"
          else
            echo "status=up" >> $GITHUB_OUTPUT
            echo "deSEC OK: $RESULT"
          fi

      - name: Check Google DNS
        id: google
        continue-on-error: true
        run: |
          RESULT=$(dig @ns-cloud-a1.googledomains.com alternatefutures.ai A +short +time=5 +tries=2 2>/dev/null || echo "TIMEOUT")
          if [ -z "$RESULT" ] || [ "$RESULT" = "TIMEOUT" ]; then
            echo "status=down" >> $GITHUB_OUTPUT
            echo "::warning::Google DNS is DOWN or not responding"
          else
            echo "status=up" >> $GITHUB_OUTPUT
            echo "Google OK: $RESULT"
          fi

      - name: Evaluate Health
        id: health
        run: |
          CF="${{ steps.cloudflare.outputs.status }}"
          DS="${{ steps.desec.outputs.status }}"
          GG="${{ steps.google.outputs.status }}"

          UP_COUNT=0
          [ "$CF" = "up" ] && UP_COUNT=$((UP_COUNT + 1))
          [ "$DS" = "up" ] && UP_COUNT=$((UP_COUNT + 1))
          [ "$GG" = "up" ] && UP_COUNT=$((UP_COUNT + 1))

          echo "up_count=$UP_COUNT" >> $GITHUB_OUTPUT
          echo "cloudflare=$CF" >> $GITHUB_OUTPUT
          echo "desec=$DS" >> $GITHUB_OUTPUT
          echo "google=$GG" >> $GITHUB_OUTPUT

          if [ $UP_COUNT -eq 0 ]; then
            echo "::error::CRITICAL: All DNS providers are DOWN!"
            echo "severity=critical" >> $GITHUB_OUTPUT
          elif [ $UP_COUNT -eq 1 ]; then
            echo "::warning::WARNING: Only 1 DNS provider is up"
            echo "severity=warning" >> $GITHUB_OUTPUT
          elif [ $UP_COUNT -eq 2 ]; then
            echo "::notice::DEGRADED: 1 DNS provider is down"
            echo "severity=degraded" >> $GITHUB_OUTPUT
          else
            echo "All DNS providers healthy"
            echo "severity=ok" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on Critical Failure
        if: steps.health.outputs.severity == 'critical' || steps.health.outputs.severity == 'warning'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `DNS Alert: ${process.env.SEVERITY} - ${process.env.UP_COUNT}/3 providers up`;
            const body = `## DNS Health Alert

            **Severity:** ${process.env.SEVERITY}
            **Time:** ${new Date().toISOString()}

            | Provider | Status |
            |----------|--------|
            | Cloudflare | ${process.env.CF} |
            | deSEC | ${process.env.DS} |
            | Google | ${process.env.GG} |

            **Action Required:** Check DNS provider dashboards and investigate.
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dns-alert'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dns-alert', 'critical']
              });
            }
        env:
          SEVERITY: ${{ steps.health.outputs.severity }}
          UP_COUNT: ${{ steps.health.outputs.up_count }}
          CF: ${{ steps.health.outputs.cloudflare }}
          DS: ${{ steps.health.outputs.desec }}
          GG: ${{ steps.health.outputs.google }}

      - name: Summary
        run: |
          echo "## DNS Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare | ${{ steps.health.outputs.cloudflare }} |" >> $GITHUB_STEP_SUMMARY
          echo "| deSEC | ${{ steps.health.outputs.desec }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Google | ${{ steps.health.outputs.google }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall:** ${{ steps.health.outputs.up_count }}/3 providers healthy" >> $GITHUB_STEP_SUMMARY
